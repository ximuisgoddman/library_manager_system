{% extends 'user_front_page/base.html' %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        <h1>{{ song.title }} - 歌词同步显示</h1>
    </div>
</div>

<div>
    <audio id="audio-player" controls>
        <source src="{{ song.audio_file.url }}" type="audio/mpeg">
        您的浏览器不支持 HTML5 音频。
    </audio>

    <div id="player">
        <button id="previous-button" onclick="playPreviousSong()">上一首</button>
        <progress id="progress" value="0" max="1"></progress>
        <span id="countdown">00:00</span>
        <span id="current-song-title">{{ song.title }}</span>
        <button id="play-pause-button" onclick="togglePlayPause()">播放</button>
        <button id="next-button" onclick="playNextSong()">下一首</button>
        <label for="play-mode">播放模式：</label>
        <select id="play-mode" onchange="changePlayMode()">
            <option value="random">随机播放</option>
            <option value="sequential">顺序播放</option>
            <option value="repeat">单曲循环</option>
        </select>

        <label for="volume">音量：</label>
        <input type="range" id="volume" min="0" max="1" step="0.001" value="0.2" onchange="updateVolume()">
    </div>

    <div id="lyrics-container">
        <div id="lyrics"></div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        var audioPlayer = document.getElementById("audio-player");
        var lyricsContainer = document.getElementById("lyrics");
        var progress = document.getElementById("progress");
        var countdownElement = document.getElementById("countdown");
        var playPauseButton = document.getElementById("play-pause-button");
        var volumeSlider = document.getElementById("volume");
        var currentSongTitle = document.getElementById("current-song-title");

        // 从 Django 传递的歌词数据
        var lyricsText = `{{ lyrics|safe }}`; // 用 safe 过滤器确保歌词文本的安全

        // 解析 LRC 歌词
        function parseLyrics(lyrics) {
            var lines = lyrics.split("\n");
            var parsed = [];
            lines.forEach(function (line) {
                var match = line.match(/\[(\d{2}):(\d{2}\.\d{2})\](.*)/);
                if (match) {
                    var minutes = parseInt(match[1], 10);
                    var seconds = parseFloat(match[2]);
                    var time = minutes * 60 + seconds;
                    var text = match[3].trim();
                    parsed.push({ time: time, text: text });
                }
            });
            return parsed;
        }

        // 显示歌词
        function displayLyrics(parsedLyrics) {
            lyricsContainer.innerHTML = '';
            parsedLyrics.forEach(function (lyric) {
                var line = document.createElement("div");
                line.className = "lyric-line";
                line.setAttribute("data-time", lyric.time);
                line.textContent = lyric.text;
                lyricsContainer.appendChild(line);
            });
        }

        // 同步歌词
        function syncLyrics(currentTime, parsedLyrics) {
            var lines = document.querySelectorAll(".lyric-line");
            var activeLine;

            parsedLyrics.forEach(function (lyric, index) {
                if (currentTime >= lyric.time) {
                    activeLine = lines[index];
                }
            });

            if (activeLine) {
                lines.forEach(function (line) { line.classList.remove("active"); });
                activeLine.classList.add("active");
                activeLine.scrollIntoView({ behavior: "smooth", block: "center" });
            }
        }

        // 播放/暂停按钮
        function togglePlayPause() {
            if (audioPlayer.paused) {
                audioPlayer.play();
                playPauseButton.textContent = '暂停';
            } else {
                audioPlayer.pause();
                playPauseButton.textContent = '播放';
            }
        }

        // 音量控制
        function updateVolume() {
            audioPlayer.volume = volumeSlider.value;
        }

        // 更新进度条
        function updateProgressBar() {
            if (audioPlayer && isFinite(audioPlayer.duration) && isFinite(audioPlayer.currentTime)) {
                progress.value = audioPlayer.currentTime / audioPlayer.duration;
                updateCountdown(audioPlayer.duration - audioPlayer.currentTime);
            }
        }

        // 更新倒计时
        function updateCountdown(totalSeconds) {
            var minutes = Math.floor(totalSeconds / 60);
            var seconds = totalSeconds % 60;

            var minutesDisplay = minutes < 10 ? "0" + minutes : minutes;
            var secondsDisplay = seconds < 10 ? "0" + seconds : seconds;
            countdownElement.textContent = minutesDisplay + ":" + secondsDisplay;
        }

        // 播放下一首
        function playNextSong() {
            console.log("playNextSong被调用");
            var currentSongId = currentlyPlayingSong.getAttribute('data-song-id');
            var currentSongIndex = -1;
            for (var i = 0; i < songs.length; i++) {
                var tmp = songs[i]['song_id'].toString();
                if (tmp === currentSongId) {
                    currentSongIndex = i;
                    break;
                }
            }
            console.log("next当前歌曲：", currentSongIndex)
            var nextSongIndex;
            if (playMode === "sequential") {
                nextSongIndex = (currentSongIndex + 1) % songs.length;
            } else if (playMode === "random") {
                nextSongIndex = Math.floor(Math.random() * songs.length);
            } else if (playMode === "repeat") {
                nextSongIndex = currentSongIndex;
            }
            console.log("next要播放", songs[nextSongIndex]['song_id']);
            // currentlyPlayingSong = audioElements[songs[nextSongIndex]['song_id']];
            playSong(songs[nextSongIndex]['song_id']);
        }

        function playPreviousSong() {
            var currentSongId = currentlyPlayingSong.getAttribute('data-song-id');
            var currentSongIndex = -1;
            for (var i = 0; i < songs.length; i++) {

                var tmp = songs[i]['song_id'].toString();
                if (tmp === currentSongId) {
                    currentSongIndex = i;
                    break;
                }
            }
            console.log("pre当前歌曲：", currentSongIndex, currentSongId)
            var previousSongIndex = (currentSongIndex - 1 + songs.length) % songs.length;
            console.log("pre要播放的歌曲", songs[previousSongIndex]['song_id'])
            playSong(songs[previousSongIndex]['song_id']);
        }

        function changePlayMode() {
            playMode = playModeSelect.value;
        }

        // 解析并显示歌词
        var parsedLyrics = parseLyrics(lyricsText);
        displayLyrics(parsedLyrics);

        // 监听音频时间更新事件
        audioPlayer.addEventListener("timeupdate", function () {
            var currentTime = audioPlayer.currentTime;
            syncLyrics(currentTime, parsedLyrics);
        });

        // 进度条点击跳转
        progress.addEventListener("click", function (event) {
            var clickPosition = event.clientX - progress.getBoundingClientRect().left;
            var progressBarWidth = progress.offsetWidth;
            var progressRatio = clickPosition / progressBarWidth;
            var seekTime = audioPlayer.duration * progressRatio;
            audioPlayer.currentTime = seekTime;
        });

        // 音量滑块
        volumeSlider.addEventListener("input", updateVolume);

        // 更新进度条
        setInterval(updateProgressBar, 1000);
    });
</script>

<style>
    #lyrics-container {
        height: 300px;
        overflow-y: auto;
        background-color: #f9f9f9;
        padding: 10px;
        border: 1px solid #ddd;
        margin-top: 20px;
    }

    .lyric-line {
        margin: 5px 0;
        font-size: 16px;
        line-height: 1.5;
    }

    .lyric-line.active {
        color: #f00;
        font-weight: bold;
    }

    #player {
        margin-top: 20px;
    }

    #progress {
        width: 100%;
    }
</style>
{% endblock %}