<!DOCTYPE html>
<html>
<head>
    <title>Snake Game</title>
    <style>
        canvas {
            border: 1px solid black;
        }
    </style>
</head>
<body>
    <h1>Snake Game</h1>

    <canvas id="gameCanvas" width="640" height="480"></canvas>
    <div id="scoreDisplay"
        style="color: rgb(255, 255, 255); font-size: 24px; position: absolute; top: 20px; left: 20px;"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const canvas = document.getElementById('gameCanvas');
            const context = canvas.getContext('2d');
            const WINDOW_WIDTH=JSON.parse('{{WINDOW_WIDTH|safe}}');
            const WINDOW_HEIGHT=JSON.parse('{{WINDOW_HEIGHT|safe}}');
            const MOVE_SPEED=JSON.parse('{{move_speed|safe}}');
            const SNAKE_SIZE=JSON.parse('{{snake_size|safe}}');
            const Foods=JSON.parse('{{Origin_foods|safe}}');
            const Snakes=JSON.parse('{{snakes|safe}}');
            var x=WINDOW_WIDTH/2;
            var y=WINDOW_HEIGHT/2;
            let game_over=false;

            // 更新分数显示
            function updateScoreDisplay(score) {
                const scoreDisplay = document.getElementById('scoreDisplay');
                scoreDisplay.innerHTML = 'Score: ' + score;
            }

            function drawSnake(Snakes) {
                for (let i = 0; i < Snakes.length; i++) {
                    context.fillStyle = 'green';
                    context.fillRect(Snakes[i].x, Snakes[i].y, SNAKE_SIZE, SNAKE_SIZE);
                }
            }

            function drawFood(foods) {
                for(let i=0;i<foods.size;i++){
                    context.fillStyle = 'red';
                context.fillRect(foods[i].x, foods[i].y, foodSize, foodSize);
                }
                
            }

            // 更新分数显示
            function updateScoreDisplay(score) {
                const scoreDisplay = document.getElementById('scoreDisplay');
                scoreDisplay.innerHTML = 'Score: ' + score;
            }

             // 处理键盘事件
             document.addEventListener('keydown', function (event) {
                const key = event.key;
                sendUpdateToServer(key);
            });
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }


            // 请求更新游戏状态
            function sendUpdateToServer(key) {

                if (game_over) {
                    return; // 如果游戏结束，不再向服务器发送请求
                }
                // 获取Cookie中的CSRF令牌
                const csrfToken = getCookie('csrftoken');
                $.ajax({
                    type: 'POST',
                    url: '/update_snake_state/',
                    data: { "key_event": key,  },
                    dataType: 'json',
                    headers: {
                        'X-CSRFToken': csrfToken
                    },
                    success: function (data) {
                        // 服务器返回更新后的游戏数据
                        // 根据data中的内容来更新游戏画布
                        // 在这里，你可以使用data.play_matrix来更新游戏区域
                        // 使用data.current_piece来更新当前方块的位置
                        // 使用data.score来更新得分信息
                        if (data.game_over) {
                            // 清空整个页面
                            // showGameOverDialog();
                            // 如果需要重新开始游戏，可以重新加载页面
                            window.location.reload();
                        } else {
                            // 清空画布
                            ctx.clearRect(0, 0, WINDOW_WIDTH, WINDOW_HEIGHT);

                            // 绘制游戏区域
                            drawSnake(data.snake_list);

                            drawFood(data.foods);
                            updateScoreDisplay(data.snake_list.length);
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error(error);
                    }
                });
            }
        });
    </script>
</body>
</html>
